<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>ESP Realtime • Cihaz İzleme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0c10; --card:#111318; --text:#e6e7eb; --muted:#9aa0a6; --ok:#15c27f; --bad:#ff5d5d; --warn:#ffb020; }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px; margin:40px auto; padding:0 16px}
    h1{margin:0 0 18px; font-size:28px}
    .subtitle{color:var(--muted); margin-bottom:22px}
    .card{background:var(--card); border:1px solid #1f2430; border-radius:18px; padding:18px; box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .item{padding:14px; border:1px solid #232735; border-radius:14px; background:#0f1116}
    .label{color:var(--muted); font-size:12px; letter-spacing:.4px; text-transform:uppercase}
    .value{margin-top:6px; font-size:18px; font-weight:600}
    .badges{display:flex; gap:6px; flex-wrap:wrap}
    .badge{display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; font-weight:600}
    .ok{background:rgba(21,194,127,.15); color:var(--ok); border:1px solid rgba(21,194,127,.35)}
    .bad{background:rgba(255,93,93,.15); color:var(--bad); border:1px solid rgba(255,93,93,.35)}
    .footer{margin-top:14px; color:var(--muted); font-size:13px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ESP Realtime • Cihaz İzleme</h1>
    <div class="subtitle">Karttan gelen son telemetri; yeni veri gelince anında güncellenir.</div>

    <div class="card">
      <div class="grid">
        <div class="item"><div class="label">Cihaz ID</div><div id="deviceId" class="value mono">—</div></div>
        <div class="item"><div class="label">Wi-Fi</div><div id="wifi" class="value badges">—</div></div>
        <div class="item"><div class="label">GSM</div><div id="gsm" class="value badges">—</div></div>
        <div class="item"><div class="label">BLE Conf</div><div id="bleConf" class="value badges">—</div></div>
        <div class="item"><div class="label">Güç</div><div id="power" class="value badges">—</div></div>

        <div class="item"><div class="label">Batarya</div><div id="battery" class="value">—</div></div>
        <div class="item"><div class="label">Sıcaklık</div><div id="temperature" class="value">—</div></div>
        <div class="item"><div class="label">Nem</div><div id="humidity" class="value">—</div></div>
        <div class="item"><div class="label">CO</div><div id="co" class="value">—</div></div>
        <div class="item"><div class="label">PDM</div><div id="pdm" class="value badges">—</div></div>

        <div class="item" style="grid-column:1/-1"><div class="label">Hata Bayrağı</div><div id="error" class="value mono">—</div></div>
      </div>

      <div class="footer">
        <div>Son güncelleme: <span id="ts">—</span></div>
        <div id="status" class="mono">Durum: bekleniyor…</div>
      </div>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const badge = ok => `<span class="badge ${ok?'ok':'bad'}">${ok?'AÇIK':'KAPALI'}</span>`;
    const fmt = {
      battery:v => Number.isFinite(v)?`${v}%`:'—',
      temperature:v => Number.isFinite(v)?`${v.toFixed(1)} °C`:'—',
      humidity:v => Number.isFinite(v)?`${v}%`:'—',
      co:v => Number.isFinite(v)?v:'—',
      bool:v => badge(!!Number(v))
    };

    function render(d){
      if(!d){ el('status').textContent='Durum: veri yok'; return; }
      el('deviceId').textContent  = d.deviceId ?? '—';
      el('wifi').innerHTML        = fmt.bool(d.wifi);
      el('gsm').innerHTML         = fmt.bool(d.gsm);
      el('bleConf').innerHTML     = fmt.bool(d.bleConf);
      el('power').innerHTML       = fmt.bool(d.power);
      el('battery').innerHTML     = fmt.battery(Number(d.battery));
      el('temperature').innerHTML = fmt.temperature(Number(d.temperature));
      el('humidity').innerHTML    = fmt.humidity(Number(d.humidity));
      el('co').innerHTML          = fmt.co(Number(d.co));
      el('pdm').innerHTML         = fmt.bool(d.pdm);
      el('error').textContent     = d.error ?? '—';
      el('ts').textContent        = d.ts ? new Date(d.ts).toLocaleTimeString() : '—';
      el('status').textContent    = 'Durum: bağlı (SSE)';
    }

    const es = new EventSource('/stream');  // anında güncelle
    es.addEventListener('init', ev => render(JSON.parse(ev.data)));
    es.onmessage = ev => render(JSON.parse(ev.data));
    es.onerror = () => { el('status').textContent = 'Durum: tekrar bağlanılıyor…'; };

    fetch('/data/latest').then(r=>r.json()).then(j=>render(j.latest)).catch(()=>{});
  </script>
</body>
</html>
